rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // Profiles collection
    match /profiles/{userId} {
      // Anyone can read profiles (for user discovery and online status)
      allow read: if true;
      
      // Anyone can create a profile (self-registration)
      allow create: if true;
      
      // Allow updates (for heartbeat and profile changes)
      allow update: if true;
      
      // Prevent deletion of profiles
      allow delete: if false;
    }
    
    // Ships collection (read-only for all users)
    match /ships/{shipId} {
      allow read: if true;
      allow write: if false; // Only admins can modify via Firebase Console
    }
    
    // Channels collection
    match /channels/{channelId} {
      // Allow reading channels list (for cleanup)
      allow read: if true;
      
      // Anyone can create channels
      // Validate that participants array exists and has 2 users
      allow create: if request.resource.data.participants.size() == 2;
      
      // Channels can be updated (for lastMessage)
      // Validate that participants array is not modified
      allow update: if request.resource.data.participants == resource.data.participants;
      
      // Prevent deletion of channels
      allow delete: if false;
      
      // Messages subcollection
      match /messages/{messageId} {
        // Anyone can read messages
        allow read: if true;
        
        // Anyone can create messages
        // Validate required fields exist
        allow create: if request.resource.data.text is string &&
                         request.resource.data.senderId is string &&
                         request.resource.data.senderName is string &&
                         request.resource.data.timestamp is timestamp;
        
        // Messages are immutable (no updates)
        allow update: if false;
        
        // Allow deletion of messages (for cleanup)
        allow delete: if true;
      }
    }
  }
}